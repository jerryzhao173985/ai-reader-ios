{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. Defensive correctness valued over brevity when it aids maintainer understanding.",
      "added_at": "2026-01-22T10:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library, TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions), inline markers [1][2][3], delete highlight + undo (flicker-free via JS injection), haptic feedback, brain icon chapter highlights list, cross-chapter analysis persistence. Thread-per-analysis architecture: each analysis type has its own independent conversation thread with follow-ups. GitHub: https://github.com/jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-22T18:30:00.000000"
    },
    {
      "type": "technical",
      "content": "SwiftData architecture: book.highlights = ALL highlights (book-scoped), currentChapterHighlights = filtered for current chapter. AIAnalysisModel.prompt/response = initial Q&A; AIAnalysisModel.thread.turns = follow-ups only. selectedAnalysis tracks current analysis for conversation display. Thread-per-analysis: Fact Check, Discussion, Custom Q each have independent threads - follow-ups append to the viewed analysis's thread.",
      "added_at": "2026-01-22T18:30:00.000000"
    },
    {
      "type": "technical",
      "content": "WKWebView scroll/flicker prevention: JS injection for marker/color/undo updates (not loadHTMLString). Dual hash tracking (baseContentHash, styledContentHash). Selection preservation via hasActiveTextSelection + pendingMarkerUpdatesQueue. goToChapter() MUST clear hasActiveTextSelection first to ensure cross-chapter analysis uses immediate update path.",
      "added_at": "2026-01-22T15:20:00.000000"
    },
    {
      "type": "decision",
      "content": "State Management Patterns: (1) Atomic State Transitions: When multiple state variables represent a logical state, update them ALL together. selectHighlight() active job branch MUST set: isAnalyzing, analysisResult, selectedAnalysis=nil, currentAnalysisType=nil. (2) Two Distinct Actions: performAnalysis() clears selectedAnalysis=nil for clean loading view; askFollowUpQuestion() captures analysisToFollowUp=selectedAnalysis at function START before async work. (3) State Symmetry: All deselection paths (X button, goToChapter, deleteHighlight, selectHighlight active job) must clear full state set. (4) Race Condition Guards: highlightToJobMap tracks ONE active job per highlight; isActiveJob guards UI updates ONLY, not data persistence. (5) Duplicate Prevention: Content-based detection (question+answer match) in addTurnToThread(). (6) Principle: User intent trumps background job completion.",
      "added_at": "2026-01-23T18:00:00.000000"
    },
    {
      "type": "bugfix",
      "content": "selectHighlight() stale state bug (2026-01-23): Active job branch only updated isAnalyzing/analysisResult but left selectedAnalysis/currentAnalysisType stale from previous highlight. Fix: Added selectedAnalysis=nil, currentAnalysisType=nil in active job branch (L923-927). Root cause: Violated atomic state transition principle. Bug manifests when: Highlight A streaming → tap Highlight B → tap back to A. Full investigation documented in docs/bug-investigation-selectHighlight-stale-state.md.",
      "added_at": "2026-01-23T18:00:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [
    {
      "type": "claude_response",
      "content": "Memory consolidated: 11 → 6 memories. Cleared session fragments, updated state management decision with atomic transitions principle, added bugfix reference to investigation doc.",
      "added_at": "2026-01-23T18:01:56.532330",
      "source": "realtime_capture"
    },
    {
      "type": "message",
      "content": "commit the staged files",
      "added_at": "2026-01-23T18:01:56.532342",
      "source": "realtime_capture"
    }
  ],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-23T18:01:56.532343"
}