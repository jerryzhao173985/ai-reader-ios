{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. Defensive correctness valued over brevity when it aids maintainer understanding. User values first-principles thinking, careful verification before committing, and 'fresh eyes' review of all changes.",
      "added_at": "2026-01-22T10:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library (book context menu: Highlights/Delete), TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions, comments), inline markers [1][2][3], delete highlight + undo, delete individual analysis (X button), haptic feedback, brain icon chapter highlights list, cross-chapter analysis persistence, analysis count badges. HighlightsView: accessible via Library long-press, exports (Markdown/JSON/Clipboard), in-place analysis expansion via HighlightDetailSheet. Comment feature: user notes without AI call, follow-ups work normally. HighlightAnalysisManager enables standalone analysis ops outside reader context. AI: Dual-API support - GPT-5.2 (Responses API with configurable reasoning effort: none/low/medium/high/xhigh, default xhigh) and GPT-4o (Chat Completions API) with auto-fallback. Settings UI for model selection and reasoning effort. GitHub: https://github.com/jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-28T10:00:00.000000"
    },
    {
      "type": "technical",
      "content": "Architecture: book.highlights = ALL (book-scoped), currentChapterHighlights = filtered for chapter. AIAnalysisModel.prompt/response = initial Q&A; thread.turns = follow-ups. For comments: prompt = user's text, response = '' (empty). BOTH AnalysisPanelView (previousAnalysisCard) and HighlightsView (AnalysisCard) must show prompt for comments in card previews. WKWebView: JS injection for marker/color updates (not loadHTMLString). ChapterContentView state: 3-field tuple (highlightId, colorHex, analysisCount) for dedup. Chapter-change cleanup clears pendingMarkerUpdate and pendingUndoRestore. Parallel analysis is SAFE: saveAnalysis() writes to SwiftData immediately. Two analysis viewing contexts: (1) AnalysisPanelView in reader (active reading), (2) HighlightDetailSheet in HighlightsView (review mode, uses HighlightAnalysisManager). AI API: GPT-5.2 uses /v1/responses with input+max_output_tokens+reasoning.effort; GPT-4o uses /v1/chat/completions with messages+max_tokens. Streaming: Responses API emits response.output_text.delta, Chat Completions emits choices[0].delta.content.",
      "added_at": "2026-01-28T10:00:00.000000"
    },
    {
      "type": "decision",
      "content": "State & UX Patterns: (1) Atomic State Transitions: Update all related state variables together including analysisResult. (2) State Symmetry: All deselection/deletion/mode-change paths clear full state set including followUpInputMode. (3) Race Condition Guards: highlightToJobMap tracks ONE active job per highlight; isActiveJob guard prevents non-active job completions from resetting UI state. (4) Operation Symmetry: saveAnalysis(), selectAnalysis(), deleteAnalysis() all update colorHex and trigger pendingMarkerUpdate. (5) selectHighlight() finds analysis matching colorHex first, falls back to most recent. (6) Direct X button for delete. (7) HighlightsView: In-place expansion preferred over reader navigation (user rejected tap-to-navigate due to 1.6-2.6s WebView lag). (8) Unified Input Flow: FollowUpInputMode enum (.followUp, .askQuestion, .addComment) transforms follow-up input box behavior. (9) Job Isolation Pattern: prepareForNewCustomQuestion() clears job mapping to orphan ongoing jobs from UI updates (they still save in background). ReaderViewModel uses highlightToJobMap (multi-highlight), HighlightAnalysisManager uses activeJobId (single highlight). Both now use per-update isActiveJob check pattern - parallel jobs complete and save, only active job updates UI.",
      "added_at": "2026-01-27T21:30:00.000000"
    },
    {
      "type": "convention",
      "content": "Visual & SwiftUI Patterns: (1) Card styling: color.opacity(0.15) fill + color.opacity(0.3) stroke for HighlightRow, AnalysisCard, quote blocks. (2) Chat bubbles: User right-aligned (accentColor), AI left-aligned (secondaryBackgroundColor), Comment bubble (text.bubble icon + comment color). (3) List theming: .listRowSeparator(.hidden) + .listRowBackground(theme) + .scrollContentBackground(.hidden). (4) Sheet environment: Always pass .environment(settings) to sheets. (5) sheet(item:) pattern for optional data presentation. (6) ScrollViewReader + Transaction(disablesAnimations: true) for instant scroll reset. (7) All 5 quick analysis types + Ask Question + Comment shown in context menu. (8) Separator logic: No divider before follow-ups for bubble-style analyses (.customQuestion, .comment) - applies to BOTH AnalysisPanelView and HighlightsView.",
      "added_at": "2026-01-27T22:40:00.000000"
    },
    {
      "type": "future_enhancement",
      "content": "Portable export format (.aireader) with full data hierarchy (highlights -> analyses -> thread -> turns) for backup/restore. Import functionality to load exported data. Currently not essential - standard export (Markdown/JSON) available in HighlightsView.",
      "added_at": "2026-01-25T21:30:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-28T10:00:00.000000"
}
