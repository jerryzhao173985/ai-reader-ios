{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. OVERKILL AVOIDANCE: User explicitly stated 'I NEVER want unnecessary and not OVERKILL.' Classify fixes as: (1) ESSENTIAL - actual bug fix, (2) OPTIMIZATION - measurable improvement, (3) STYLISTIC - code preference. User only wants category 1 implemented by default. Defensive correctness valued over brevity when it aids maintainer understanding. User values first-principles thinking, careful verification before committing, and 'fresh eyes' review of all changes. Smooth reading UX critical: no flicker, no scroll jumps, no selection loss. For prompt formatting: use - symbols for lists, avoid special symbols like checkmarks or X marks. SIMPLICITY VALUED: User questions added infrastructure - prefer minimal storage that achieves the goal.",
      "added_at": "2026-01-31T14:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library (book context menu: Highlights/Delete), TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions, comments), inline markers [1][2][3], delete highlight + undo, delete individual analysis (X button), haptic feedback, brain icon chapter highlights list, cross-chapter analysis persistence, analysis count badges. HighlightsView: accessible via Library long-press, exports (Markdown/JSON/Clipboard), in-place analysis expansion via HighlightDetailSheet. Comment feature: user notes without AI call, follow-ups work normally. HighlightAnalysisManager enables standalone analysis ops outside reader context for library-based analysis. AI: Dual-API support - GPT-5.2 (Responses API with reasoning effort + web_search tool) and GPT-4o (Chat Completions API) with auto-fallback. Model/webSearch tracking per analysis. GitHub: jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-28T23:30:00.000000"
    },
    {
      "type": "technical",
      "content": "Architecture: book.highlights = ALL (book-scoped), currentChapterHighlights = filtered for chapter. AIAnalysisModel.prompt/response = initial Q&A; thread.turns = follow-ups. For comments: prompt = user's text, response = '' (empty). WKWebView: JS injection for marker/color updates (not loadHTMLString). Dual hash tracking (baseContentHash, styledContentHash). Selection preservation: defer marker AND colorHex updates when hasActiveTextSelection=true to pendingMarkerUpdatesQueue. Call clearSelection() after creating highlights. ChapterContentView state: 3-field tuple (highlightId, colorHex, analysisCount) for dedup. Two analysis viewing contexts: (1) AnalysisPanelView in reader, (2) HighlightDetailSheet in HighlightsView. AI API: GPT-5.2 uses /v1/responses with input+max_output_tokens+reasoning.effort+tools[web_search]; GPT-4o uses /v1/chat/completions. AIConfiguration cached at book open; settings accessed only from Library. SwiftData migration: New required properties need PROPERTY-level defaults for lightweight migration.",
      "added_at": "2026-01-28T14:50:00.000000"
    },
    {
      "type": "technical",
      "content": "Swift 6.2 Concurrency (iOS 26+): Three-layer job tracking: (1) UI layer: highlightToJobMap - latest job for streaming, (2) Ownership layer: highlightToJobIds - all jobs per highlight, (3) Cancellation layer: cancelledJobs Set. Polling uses two-layer cancellation: cancelledJobs.contains(jobId) && !Task.isCancelled (defense-in-depth). cleanupJob() handles all layers via defer. AsyncThrowingStream pattern: capture Task in variable, add onTermination handler to cancel task. CRITICAL: Task.isCancelled checks needed in ALL streaming loops INCLUDING fallback loops - unstructured Tasks do NOT propagate cancellation to inner Tasks (only async let and TaskGroup do). DEINIT: Use `isolated deinit` (SE-0371) for @MainActor classes - NOT MainActor.assumeIsolated. AIService.deinit calls session.invalidateAndCancel() (thread-safe, no isolation needed). SENDABLE: Explicit conformance on AIConfiguration, AIError, StreamEvent, NonStreamingResult, FollowUpInputMode, and all enums (AnalysisType, AIProvider, ReasoningEffort, Theme, FontFamily). AIError.networkError uses String (not Error) for Sendable compliance. Tasks created from @MainActor classes inherit isolation - no MainActor.run needed. DispatchQueue.main.async â†’ Task { @MainActor in }. [weak self] RULES: Required for Tasks with delays in NSObject/Coordinator classes; NOT applicable to SwiftUI structs (value types) or immediate Tasks. DEBOUNCE PATTERN: Cancel-and-replace (task?.cancel(); task = Task { try await Task.sleep(for:); doWork() }). Duration API preferred (.milliseconds, .seconds) over nanoseconds.",
      "added_at": "2026-01-31T17:15:00.000000"
    },
    {
      "type": "decision",
      "content": "State & UX Patterns: (1) Atomic State Transitions: Update all related state variables together. (2) State Symmetry: All deselection/deletion/mode-change paths clear full state set. (3) Race Condition Guards: highlightToJobMap tracks ONE active job per highlight; isActiveJob guard prevents non-active job completions from resetting UI state. (4) Operation Symmetry: saveAnalysis(), selectAnalysis(), deleteAnalysis() all update colorHex and trigger pendingMarkerUpdate. (5) HighlightsView: In-place expansion preferred over reader navigation. (6) Job Isolation Pattern: prepareForNewCustomQuestion() clears job mapping to orphan ongoing jobs. (7) Background Job Completion Intent: User WANTS jobs to continue after HighlightDetailSheet dismisses AND after closing book - analysis saves to SwiftData when complete, available next time user opens that highlight. NO onDisappear cancellation. cancelAllActiveJobs() exists but intentionally not called on view disappear. (8) Settings Access Pattern: Settings gear only in LibraryView. User must exit book to change settings, so config is always fresh when book opens. (9) Progress Save Defense: scenePhase monitoring + onDisappear + saveProgressSync() in deinit ensures no progress loss.",
      "added_at": "2026-01-31T15:30:00.000000"
    },
    {
      "type": "convention",
      "content": "Visual & SwiftUI Patterns: (1) Card styling: color.opacity(0.15) fill + color.opacity(0.3) stroke for HighlightRow, AnalysisCard, quote blocks. (2) Chat bubbles: User right-aligned (accentColor), AI left-aligned (secondaryBackgroundColor), Comment bubble (text.bubble icon + comment color). (3) List theming: .listRowSeparator(.hidden) + .listRowBackground(theme) + .scrollContentBackground(.hidden). (4) Sheet environment: Always pass .environment(settings) to sheets. (5) sheet(item:) pattern for optional data presentation. (6) ScrollViewReader + Transaction(disablesAnimations: true) for instant scroll reset. (7) All 5 quick analysis types + Ask Question + Comment shown in context menu. (8) Separator logic: No divider before follow-ups for bubble-style analyses (.customQuestion, .comment) - applies to BOTH AnalysisPanelView and HighlightsView.",
      "added_at": "2026-01-27T22:40:00.000000"
    },
    {
      "type": "future_enhancement",
      "content": "Swift Concurrency enhancements planned in docs/swift-concurrency-enhancement-plan.md: P0 (task cancellation on navigation, graceful streaming interruption), P1 (batch analysis with TaskGroup, background notifications), P2 (progress indicators, smart pre-fetching), P3 (retry logic, multi-highlight batch). Also: portable export format (.aireader) for backup/restore - currently not essential since Markdown/JSON export available.",
      "added_at": "2026-01-29T18:30:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-31T23:00:00.000000"
}
