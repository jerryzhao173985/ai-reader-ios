{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. Defensive correctness valued over brevity when it aids maintainer understanding.",
      "added_at": "2026-01-22T10:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library, TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions), inline markers [1][2][3], delete highlight + undo (flicker-free via JS injection), haptic feedback, clickable previous analysis cards, brain icon chapter highlights list, cross-chapter analysis persistence. GitHub: https://github.com/jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-22T13:30:00.000000"
    },
    {
      "type": "technical",
      "content": "SwiftData architecture: book.highlights = ALL highlights (book-scoped, SwiftData relationship), currentChapterHighlights = filtered subset for current chapter (refreshed by loadHighlightsForCurrentChapter). Use book.highlights for cross-chapter lookups (analysis save checks, deferred marker updates). Use currentChapterHighlights for rendering HTML. Both are same SwiftData objects (references).",
      "added_at": "2026-01-22T14:20:00.000000"
    },
    {
      "type": "technical",
      "content": "WKWebView scroll/flicker prevention: JS injection for marker/color/undo updates (not loadHTMLString). Dual hash tracking (baseContentHash, styledContentHash). Selection preservation via hasActiveTextSelection + pendingMarkerUpdatesQueue. goToChapter() MUST clear hasActiveTextSelection first to ensure cross-chapter analysis uses immediate update path. Debug logging patch: 0001-Add-debug-logging-for-colorHex-update-flow-tracing.patch (reversible with git apply -R).",
      "added_at": "2026-01-22T15:20:00.000000"
    },
    {
      "type": "decision",
      "content": "AI analysis runs in background. Panel only opens when tapping inline marker [1][2][3] or brain icon. Cross-chapter analysis persistence: use book.highlights for lookups (not currentChapterHighlights). Deferred queue is chapter-scoped - hasActiveTextSelection=false on other chapters ensures immediate path.",
      "added_at": "2026-01-22T14:20:00.000000"
    },
    {
      "type": "decision",
      "content": "State Symmetry Principle: selectHighlight() sets 6 states. Cleanup paths: X button clears 4 (keeps panel open), deleteHighlight clears 6, goToChapter() clears 6 including hasActiveTextSelection (highlight selection is chapter-scoped). goToChapter() clears UI state but does NOT cancel background analysis Tasks.",
      "added_at": "2026-01-22T14:20:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-22T15:20:00.000000"
}
