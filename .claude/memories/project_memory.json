{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. Defensive correctness valued over brevity when it aids maintainer understanding. User values first-principles thinking, careful verification before committing, and 'fresh eyes' review of all changes.",
      "added_at": "2026-01-22T10:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library (book context menu: Highlights/Delete), TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions), inline markers [1][2][3], delete highlight + undo, delete individual analysis (X button), haptic feedback, brain icon chapter highlights list, cross-chapter analysis persistence, analysis count badges. HighlightsView: accessible via Library long-press, exports (Markdown/JSON/Clipboard), in-place analysis expansion via HighlightDetailSheet (no reader navigation - avoids WebView lag). Quote color syncs with expanded analysis type. HighlightAnalysisManager enables standalone analysis ops outside reader context. GitHub: https://github.com/jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-27T02:00:00.000000"
    },
    {
      "type": "technical",
      "content": "Architecture: book.highlights = ALL (book-scoped), currentChapterHighlights = filtered for chapter. AIAnalysisModel.prompt/response = initial Q&A; thread.turns = follow-ups. WKWebView: JS injection for marker/color updates (not loadHTMLString). ChapterContentView state: 3-field tuple (highlightId, colorHex, analysisCount) for dedup. Chapter-change cleanup clears pendingMarkerUpdate and pendingUndoRestore. Parallel analysis is SAFE: saveAnalysis() writes to SwiftData immediately. Two analysis viewing contexts: (1) AnalysisPanelView in reader (active reading), (2) HighlightDetailSheet in HighlightsView (review mode, uses HighlightAnalysisManager).",
      "added_at": "2026-01-27T02:00:00.000000"
    },
    {
      "type": "decision",
      "content": "State & UX Patterns: (1) Atomic State Transitions: Update all related state variables together. (2) State Symmetry: All deselection/deletion paths clear full state set. (3) Race Condition Guards: highlightToJobMap tracks ONE active job per highlight. (4) Operation Symmetry: saveAnalysis(), selectAnalysis(), deleteAnalysis() all update colorHex and trigger pendingMarkerUpdate. (5) selectHighlight() finds analysis matching colorHex first, falls back to most recent. (6) Direct X button for delete. (7) HighlightsView: In-place expansion preferred over reader navigation (user rejected tap-to-navigate due to 1.6-2.6s WebView lag). (8) 'Ask Question' button: selectedAnalysis=nil → creates NEW Custom Question thread; selectedAnalysis!=nil → appends follow-up turn to existing thread. (9) Custom questions ALWAYS show in conversation bubble style (displays the question asked).",
      "added_at": "2026-01-27T02:00:00.000000"
    },
    {
      "type": "convention",
      "content": "Visual & SwiftUI Patterns: (1) Card styling: color.opacity(0.15) fill + color.opacity(0.3) stroke for HighlightRow, AnalysisCard, quote blocks. (2) Chat bubbles: User right-aligned (accentColor), AI left-aligned (secondaryBackgroundColor). (3) List theming: .listRowSeparator(.hidden) + .listRowBackground(theme) + .scrollContentBackground(.hidden). (4) Sheet environment: Always pass .environment(settings) to sheets. (5) sheet(item:) pattern for optional data presentation (avoids race condition vs isPresented + if let). (6) ScrollViewReader + Transaction(disablesAnimations: true) for instant scroll reset. (7) All 5 quick analysis types shown (factCheck, discussion, keyPoints, argumentMap, counterpoints) + Ask Question button.",
      "added_at": "2026-01-27T02:00:00.000000"
    },
    {
      "type": "future_enhancement",
      "content": "Portable export format (.aireader) with full data hierarchy (highlights → analyses → thread → turns) for backup/restore. Import functionality to load exported data. Currently not essential - standard export (Markdown/JSON) available in HighlightsView.",
      "added_at": "2026-01-25T21:30:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [
    {
      "type": "claude_response",
      "content": "Memory consolidated: 15 → 6 memories. Integrated session learnings (Ask Question behavior, HighlightAnalysisManager, custom question display) into existing entries. Cleared realtime noise.",
      "added_at": "2026-01-27T01:45:20.665425",
      "source": "realtime_capture"
    },
    {
      "type": "message",
      "content": "Here I provide you with all your previous session all the journey of these feature improvement and synchronization for consistency and best of ability and capability to utilize as much structural and ",
      "added_at": "2026-01-27T01:45:20.665570",
      "source": "realtime_capture"
    },
    {
      "type": "claude_response",
      "content": "I've traced through the flows carefully. After reviewing the code thoroughly, **I don't find any actual bugs to fix**. The implementation is correct:\n\n---\n\n`★ Insight ─────────────────────────────────",
      "added_at": "2026-01-27T06:38:21.709399",
      "source": "realtime_capture"
    }
  ],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-27T06:38:21.709591"
}