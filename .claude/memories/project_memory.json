{
  "memories": [
    {
      "type": "preference",
      "content": "Build/test on physical iPhone 15 Pro Max via WiFi (Device ID: 00008130-001659882E43001C). User prefers fundamentally correct, complete code that addresses root causes - not minimal changes or overkill complexity. Defensive correctness valued over brevity when it aids maintainer understanding. User values first-principles thinking, careful verification before committing, and 'fresh eyes' review of all changes. Smooth reading UX critical: no flicker, no scroll jumps, no selection loss. Markers/colors appear instantly via JS. Parallel workflows must not interfere with each other. For prompt formatting: use - symbols for lists, avoid special symbols like checkmarks or X marks.",
      "added_at": "2026-01-22T10:00:00.000000"
    },
    {
      "type": "completed_feature",
      "content": "AIReaderApp: iOS EPUB reader with SwiftUI, SwiftData, WKWebView. Features: Library (book context menu: Highlights/Delete), TOC, reading progress, text highlights with AI analysis (fact-check, discussion, key points, argument map, counterpoints, custom questions, comments), inline markers [1][2][3], delete highlight + undo, delete individual analysis (X button), haptic feedback, brain icon chapter highlights list, cross-chapter analysis persistence, analysis count badges. HighlightsView: accessible via Library long-press, exports (Markdown/JSON/Clipboard), in-place analysis expansion via HighlightDetailSheet. Comment feature: user notes without AI call, follow-ups work normally. HighlightAnalysisManager enables standalone analysis ops outside reader context for library-based analysis. AI: Dual-API support - GPT-5.2 (Responses API with reasoning effort + web_search tool) and GPT-4o (Chat Completions API) with auto-fallback. Model/webSearch tracking per analysis: AIAnalysisModel stores modelUsed and usedWebSearch fields. Web search: search_context_size:high, include:[sources,results], analysis-type-specific guidance. Settings UI for model selection, reasoning effort, and web search toggle. GitHub: https://github.com/jerryzhao173985/ai-reader-ios",
      "added_at": "2026-01-28T23:30:00.000000"
    },
    {
      "type": "technical",
      "content": "Architecture: book.highlights = ALL (book-scoped), currentChapterHighlights = filtered for chapter. AIAnalysisModel.prompt/response = initial Q&A; thread.turns = follow-ups. For comments: prompt = user's text, response = '' (empty). WKWebView: JS injection for marker/color updates (not loadHTMLString). Dual hash tracking (baseContentHash, styledContentHash). Selection preservation: defer marker AND colorHex updates when hasActiveTextSelection=true to pendingMarkerUpdatesQueue. Call clearSelection() after creating highlights. ChapterContentView state: 3-field tuple (highlightId, colorHex, analysisCount) for dedup. Two analysis viewing contexts: (1) AnalysisPanelView in reader, (2) HighlightDetailSheet in HighlightsView. AI API: GPT-5.2 uses /v1/responses with input+max_output_tokens+reasoning.effort+tools[web_search]+include[sources,results]; GPT-4o uses /v1/chat/completions. Streaming: Responses API emits response.output_text.delta and response.web_search_call.* events. AIConfiguration cached at book open; settings accessed only from Library (must exit book to change). AIService.isWebSearchEnabled checks config.provider == .gpt5_2 && config.webSearchEnabled. withFallback() disables web search for GPT-4o. SwiftData migration: New required properties need PROPERTY-level defaults (not just init defaults) for lightweight migration. Use 'unknown' default for modelUsed so comments/legacy show just timestamp.",
      "added_at": "2026-01-28T14:50:00.000000"
    },
    {
      "type": "technical",
      "content": "Concurrency (@MainActor pattern): AnalysisJobManager is @MainActor final class (not actor) following Apple guidance for SwiftUI data models. All callers call synchronously (no await). Pattern: let jobId = jobManager.queueAnalysis(...) returns UUID synchronously, then Task { await pollJob() } inherits @MainActor. Parallel analysis: highlightToJobMap tracks job-to-highlight, isActiveJob guard prevents background jobs from hijacking UI. Timer callbacks require explicit MainActor hop: Timer.scheduledTimer { Task { @MainActor in ... } }. Memory cleanup: use defer { clearJob(jobId) } at top of polling functions - ensures cleanup on ANY exit path. See docs/analysis-job-threading-investigation.md for full design rationale. Swift 6 analysis identified: LibraryViewModel needs @MainActor, polling loops need Task.isCancelled checks, NonStreamingResult/EPUB structs need Sendable.",
      "added_at": "2026-01-29T18:30:00.000000"
    },
    {
      "type": "decision",
      "content": "State & UX Patterns: (1) Atomic State Transitions: Update all related state variables together. (2) State Symmetry: All deselection/deletion/mode-change paths clear full state set. (3) Race Condition Guards: highlightToJobMap tracks ONE active job per highlight; isActiveJob guard prevents non-active job completions from resetting UI state. (4) Operation Symmetry: saveAnalysis(), selectAnalysis(), deleteAnalysis() all update colorHex and trigger pendingMarkerUpdate. (5) HighlightsView: In-place expansion preferred over reader navigation. (6) Job Isolation Pattern: prepareForNewCustomQuestion() clears job mapping to orphan ongoing jobs. (7) Web search tool_choice: Use 'auto' (default), NOT 'required'. (8) Settings Access Pattern: Settings gear only in LibraryView, not in ReaderView. User must exit book to change settings, so config is always fresh when book opens.",
      "added_at": "2026-01-28T14:50:00.000000"
    },
    {
      "type": "convention",
      "content": "Visual & SwiftUI Patterns: (1) Card styling: color.opacity(0.15) fill + color.opacity(0.3) stroke for HighlightRow, AnalysisCard, quote blocks. (2) Chat bubbles: User right-aligned (accentColor), AI left-aligned (secondaryBackgroundColor), Comment bubble (text.bubble icon + comment color). (3) List theming: .listRowSeparator(.hidden) + .listRowBackground(theme) + .scrollContentBackground(.hidden). (4) Sheet environment: Always pass .environment(settings) to sheets. (5) sheet(item:) pattern for optional data presentation. (6) ScrollViewReader + Transaction(disablesAnimations: true) for instant scroll reset. (7) All 5 quick analysis types + Ask Question + Comment shown in context menu. (8) Separator logic: No divider before follow-ups for bubble-style analyses (.customQuestion, .comment) - applies to BOTH AnalysisPanelView and HighlightsView.",
      "added_at": "2026-01-27T22:40:00.000000"
    },
    {
      "type": "future_enhancement",
      "content": "Swift Concurrency enhancements planned in docs/swift-concurrency-enhancement-plan.md: P0 (task cancellation on navigation, graceful streaming interruption), P1 (batch analysis with TaskGroup, background notifications), P2 (progress indicators, smart pre-fetching), P3 (retry logic, multi-highlight batch). Also: portable export format (.aireader) for backup/restore - currently not essential since Markdown/JSON export available.",
      "added_at": "2026-01-29T18:30:00.000000"
    }
  ],
  "manual_memories": [],
  "realtime_memories": [],
  "created_at": "2026-01-20T02:42:32.320251",
  "updated_at": "2026-01-29T21:15:00.000000"
}
